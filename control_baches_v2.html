<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Control de Baches</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 640px; margin: auto; padding: 20px; background: #f5f7fa; color: #333; }
  h2 { text-align: center; color: #2c3e50; }
  label { font-weight: bold; display: block; margin-top: 15px; }
  input, select, button, textarea { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
  .picBtn { display: flex; align-items: center; gap: 8px; background: #607d8b; color: #fff; padding: 8px 12px; border-radius: 4px; font-weight: bold; width: max-content; margin-bottom: 10px; cursor: pointer; }
  .picBtn.cam { background: #2c3e50; }
  input[type=file] { display: none; }
  #estado { text-align: center; font-weight: bold; margin-top: 20px; }

  /* NUEVO: preview */
  .preview { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; }
  .preview img { width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
</style>
</head>
<body>
<h2>CONTROL DE BACHES</h2>

<form id="formBaches">

  <label>Calle:</label>
  <input type="text" id="calle" required placeholder="Ej. Calle Hidalgo">

  <label>N√∫mero:</label>
  <input type="text" id="numero" required placeholder="Ej. 123">

  <label>Colonia:</label>
  <select id="colonia" required>
<option value="">Seleccione una colonia</option>
<option value="20 de Noviembre">20 de Noviembre</option>
<option value="7 Luminarias">7 Luminarias</option>
<option value="Ampliaci√≥n 20 de Noviembre">Ampliaci√≥n 20 de Noviembre</option>
<option value="Centro">Centro</option>
<option value="Camembaro">Camembaro</option>
<option value="Ecologista">Ecologista</option>
<option value="El Chorrito">El Chorrito</option>
<option value="El Prado">El Prado</option>
<option value="El Socorro">El Socorro</option>
<option value="Emiliano Zapata">Emiliano Zapata</option>
<option value="Francisco Villa">Francisco Villa</option>
<option value="Granados">Granados</option>
<option value="Ignacio Ram√≠rez">Ignacio Ram√≠rez</option>
<option value="Industrial">Industrial</option>
<option value="Isabel la Cat√≥lica">Isabel la Cat√≥lica</option>
<option value="Jarr√≥n Azul">Jarr√≥n Azul</option>
<option value="La Gallega">La Gallega</option>
<option value="La Haciendita">La Haciendita</option>
<option value="La Loma">La Loma</option>
<option value="Labradores">Labradores</option>
<option value="Lagunilla de Malpais">Lagunilla de Malpais</option>
<option value="Las Fuentes">Las Fuentes</option>
<option value="Las Haciendas">Las Haciendas</option>
<option value="Lindavista">Lindavista</option>
<option value="Loma Dorada">Loma Dorada</option>
<option value="Los Pinos">Los Pinos</option>
<option value="Luis Donaldo Colosio">Luis Donaldo Colosio</option>
<option value="Magisterial">Magisterial</option>
<option value="Malpais">Malpais</option>
<option value="Manuel Serrano Vallejo">Manuel Serrano Vallejo</option>
<option value="Miravalle">Miravalle</option>
<option value="Molinito del Cerrito">Molinito del Cerrito</option>
<option value="Morelos">Morelos</option>
<option value="Pedregal de Malpais">Pedregal de Malpais</option>
<option value="Praderas del Sol">Praderas del Sol</option>
<option value="Rancho los Molina">Rancho los Molina</option>
<option value="Ranchos Unidos">Ranchos Unidos</option>
<option value="Residencial Magisterio">Residencial Magisterio</option>
<option value="San Jos√©">San Jos√©</option>
<option value="San Juanito">San Juanito</option>
<option value="Santiago Malpais">Santiago Malpais</option>
<option value="Santiago UCOC">Santiago UCOC</option>
<option value="Tepamal">Tepamal</option>
<option value="Valle Dorado">Valle Dorado</option>
<option value="Otra">Otra</option>
  </select>

  <div id="otraColoniaBox" style="display:none;">
    <label>Ingrese colonia:</label>
    <input type="text" id="otraColonia" placeholder="Nombre de colonia no listada">
  </div>

  <label>Descripci√≥n del bache:</label>
  <select id="descripcion" required>
  <option value="">Seleccione el tipo de bache</option>
  <option value="Asfalto">En Asfalto</option>
  <option value="Concreto">En Concreto</option>
  <option value="Piedra">En Piedra</option>
  </select>

  <label>Ancho (metros):</label>
  <input type="number" id="ancho" step="any" required>

  <label>Largo (metros):</label>
  <input type="number" id="largo" step="any" required>

  <!--<label>Profundidad (metros):</label> -->
  <!-- <input type="number" id="profundidad" step="any" required> -->

  <label>üì∑ Evidencia fotogr√°fica (obligatoria):</label>
  <label class="picBtn cam">üì∑ Tomar foto
    <input type="file" id="camInput" accept="image/*" capture="environment">
  </label>
  <label class="picBtn">üñºÔ∏è Elegir de galer√≠a
    <input type="file" id="galInput" accept="image/*">
  </label>

  <!-- NUEVO: Preview -->
  <div id="preview" class="preview"></div>

  <button type="submit">Enviar</button>
</form>

<p id="estado"></p>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxSt9UjXIyLXkBeastlt21mObgBicwi92WgO6CjPMxqyMsceFO70Pm7pi5WrBQyfEkf/exec";

const coloniaSel  = document.getElementById("colonia");
const otraBox     = document.getElementById("otraColoniaBox");
const otraColonia = document.getElementById("otraColonia");
const camInput    = document.getElementById("camInput");
const galInput    = document.getElementById("galInput");
const estado      = document.getElementById("estado");
const previewBox  = document.getElementById("preview");

coloniaSel.addEventListener("change", () => {
  otraBox.style.display = coloniaSel.value === "Otra" ? "block" : "none";
});

/* ===== NUEVO: mostrar preview al elegir imagen ===== */
camInput.addEventListener("change", e => { if(e.target.files[0]) previewFile(e.target.files[0]); });
galInput.addEventListener("change", e => { if(e.target.files[0]) previewFile(e.target.files[0]); });

function previewFile(file){
  const r = new FileReader();
  r.onload = () => {
    previewBox.innerHTML = "";
    const img = document.createElement("img");
    img.src = r.result;
    img.alt = "Vista previa";
    previewBox.appendChild(img);
  };
  r.readAsDataURL(file);
}

/* ===== NUEVO: compresi√≥n antes de enviar ===== */
function readAndCompressAsDataURL(file, maxSide=1600, quality=0.85){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const url = reader.result; // dataURL original
      const img = new Image();
      img.onload = () => {
        let { width, height } = img;
        const scale = Math.min(1, maxSide / Math.max(width, height));
        if (scale < 1) {
          const canvas = document.createElement("canvas");
          canvas.width = Math.round(width * scale);
          canvas.height = Math.round(height * scale);
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          try {
            const out = canvas.toDataURL("image/jpeg", quality);
            resolve(out);
          } catch (e) {
            // Fallback si algo falla
            resolve(url);
          }
        } else {
          resolve(url);
        }
      };
      img.onerror = reject;
      img.src = url;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

document.getElementById("formBaches").addEventListener("submit", async (e) => {
  e.preventDefault();

  // GPS
  let lat = "", lon = "";
  try {
    const pos = await new Promise((ok, err) => navigator.geolocation.getCurrentPosition(ok, err, {
      enableHighAccuracy: true, timeout: 8000, maximumAge: 0
    }));
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
  } catch (err) {
    alert("No se pudo obtener la ubicaci√≥n: " + err.message);
    return;
  }

  // Foto
  const file = camInput.files[0] || galInput.files[0];
  if (!file) { alert("Debes adjuntar una imagen."); return; }

  estado.textContent = "Procesando imagen‚Ä¶";
  // NUEVO: comprimimos a dataURL (JPEG ~85%, m√°x 1600px)
  let dataUrl;
  try{
    dataUrl = await readAndCompressAsDataURL(file, 1600, 0.85);
  }catch(err){
    console.warn("No se pudo comprimir, enviando original.", err);
    // fallback: enviar original como dataURL
    dataUrl = await new Promise((res) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.readAsDataURL(file);
    });
  }

  const data = {
    calle: document.getElementById("calle").value,
    numero: document.getElementById("numero").value,
    colonia: coloniaSel.value === "Otra" ? otraColonia.value : coloniaSel.value,
    descripcion: document.getElementById("descripcion").value,
    ancho: document.getElementById("ancho").value,
    largo: document.getElementById("largo").value,
    latitud: lat,
    longitud: lon,
    imgName: file.name,
    imgData: dataUrl  // dataURL (ya comprimido si aplic√≥)
  };

  estado.textContent = "Enviando...";

  try {
    const resp = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(data)
    });
    const txt = await resp.text();
    let json; try { json = JSON.parse(txt); } catch { json = {status:"ok"}; }

    if (json.status === "ok") {
      estado.textContent = "Formulario enviado correctamente.";
      document.getElementById("formBaches").reset();
      otraBox.style.display = "none";
      previewBox.innerHTML = ""; // limpiar preview
    } else {
      estado.textContent = "Error: " + (json.message || "No se pudo guardar.");
      console.error(json);
    }
  } catch (err) {
    estado.textContent = "Error al enviar el formulario.";
    console.error(err);
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revisi√≥n de Tanques Superficiales</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      max-width:600px;
      margin:auto;
      padding:20px;
      background:#f5f7fa;
      color:#333;
    }
    h2{ text-align:center;color:#2c3e50;margin-bottom:25px }
    label{font-weight:bold;margin-top:15px;display:block}
    input[type="text"],
    select,
    button{width:100%;padding:10px;font-size:1em;margin-bottom:15px;
           border:1px solid #ccc;border-radius:5px}
    .radio-group{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}
    .radio-group label{display:flex;align-items:center;gap:5px;font-weight:normal}
    button{background:#2c3e50;color:#fff;border:none;cursor:pointer}
    button:hover{background:#1a242f}
    #estado{text-align:center;font-weight:bold;margin-top:20px}
    /* Botones c√°mara / galer√≠a */
    .picBtn{display:flex;align-items:center;gap:8px;
            background:#607d8b;color:#fff;padding:8px 12px;border-radius:4px;
            cursor:pointer;font-weight:bold;width:max-content}
    .picBtn.cam{background:#2c3e50}
    input[type="file"]{display:none}

    /* ===== Miniaturas compactas y contextuales ===== */
    .previewWrap{
      display:none;            /* se muestra cuando haya imagen */
      margin-top:8px;
    }
    .thumbBox{
      width:180px;             /* miniatura m√°s peque√±a */
      height:120px;
      border:1px dashed #b0bec5;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
      overflow:hidden;
    }
    .thumb{
      width:100%;
      height:100%;
      object-fit:cover;        /* recorte agradable sin deformar */
      display:block;
    }
    .fileMeta{
      font-size:0.85em;
      color:#546e7a;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <h2>REVISI√ìN DE TANQUES SUPERFICIALES</h2>

  <form id="tanqueForm">
    <!-- Tanque -->
    <label for="tanque">Tanque:</label>
    <select id="tanque" required>
      <option value="">Seleccione‚Ä¶</option>
      <option>GEMELOS</option>
      <option>TANQUE 2</option>
      <option>MEGA TANQUE</option>
      <option>FRANCISCO VILLA</option>
      <option>FONAPO</option>
      <option>LUIS ORTEGA</option>
      <option>BICENTENARIO</option>
    </select>

    <!-- Nivel -->
    <label>Nivel del Tanque:</label>
    <div class="radio-group">
      <label><input type="radio" name="nivel" value="1 METRO" required> 1 METRO</label>
      <label><input type="radio" name="nivel" value="2 METROS"> 2 METROS</label>
      <label><input type="radio" name="nivel" value="3 METROS"> 3 METROS</label>
    </div>

    <!-- Supervisi√≥n -->
    <label>Supervisi√≥n del Predio:</label>
    <div class="radio-group">
      <label><input type="radio" name="supervision" value="BIEN" required> BIEN</label>
      <label><input type="radio" name="supervision" value="ANOMAL√çA"> ANOMAL√çA</label>
    </div>

    <!-- Anomal√≠a -->
    <label for="anomalia">Narrar Anomal√≠a:</label>
    <input type="text" id="anomalia" placeholder="Describe si aplica" />

    <!-- Evidencia -->
    <label>Evidencia (imagen):</label>

    <!-- Zona de C√ÅMARA con su preview debajo -->
    <div id="camZone" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px">
      <label class="picBtn cam">
        üì∑ Tomar foto
        <input type="file" id="camInput" accept="image/*" capture="environment">
      </label>
      <div id="previewCam" class="previewWrap">
        <div class="thumbBox"><img id="thumbCam" class="thumb" alt="Miniatura c√°mara"></div>
        <div id="fileMetaCam" class="fileMeta"></div>
      </div>
    </div>

    <!-- Zona de GALER√çA con su preview debajo -->
    <div id="galZone" style="display:flex;flex-direction:column;gap:6px;margin-bottom:20px">
      <label class="picBtn">
        üñºÔ∏è Elegir de galer√≠a
        <input type="file" id="galInput" accept="image/*">
      </label>
      <div id="previewGal" class="previewWrap">
        <div class="thumbBox"><img id="thumbGal" class="thumb" alt="Miniatura galer√≠a"></div>
        <div id="fileMetaGal" class="fileMeta"></div>
      </div>
    </div>

    <!-- Coordenadas -->
    <input type="hidden" id="latitud">
    <input type="hidden" id="longitud">

    <button type="submit">Enviar</button>
  </form>

  <p id="estado"></p>

  <script>
    /* URL de tu Web App */
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxA6n_CGGD7zB1nlL310mxQbfs4hU81DKkOAC5WNBUQHWmG2zFr7Skc6hjGyBRKwvSK/exec";

    // Helpers de miniatura (una por origen)
    let lastUrlCam = null;
    let lastUrlGal = null;

    function humanSize(bytes){
      if (!bytes && bytes !== 0) return "";
      const k = 1024;
      const units = ["B","KB","MB","GB"];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      return (bytes/Math.pow(k,i)).toFixed(1) + " " + units[i];
    }

    function showPreview(file, origin){
      if(!file) return;

      if(origin === 'cam'){
        // limpiar otra
        document.getElementById('previewGal').style.display = 'none';
        if(lastUrlGal){ URL.revokeObjectURL(lastUrlGal); lastUrlGal = null; }

        if(lastUrlCam){ URL.revokeObjectURL(lastUrlCam); lastUrlCam = null; }
        const url = URL.createObjectURL(file);
        lastUrlCam = url;

        const img = document.getElementById('thumbCam');
        const wrap = document.getElementById('previewCam');
        const meta = document.getElementById('fileMetaCam');

        img.src = url;
        img.onload = () => { URL.revokeObjectURL(url); lastUrlCam = null; };
        meta.textContent = `${file.name} ‚Ä¢ ${humanSize(file.size)} ‚Ä¢ ${file.type || 'imagen'}`;
        wrap.style.display = 'block';
      }

      if(origin === 'gal'){
        // limpiar otra
        document.getElementById('previewCam').style.display = 'none';
        if(lastUrlCam){ URL.revokeObjectURL(lastUrlCam); lastUrlCam = null; }

        if(lastUrlGal){ URL.revokeObjectURL(lastUrlGal); lastUrlGal = null; }
        const url = URL.createObjectURL(file);
        lastUrlGal = url;

        const img = document.getElementById('thumbGal');
        const wrap = document.getElementById('previewGal');
        const meta = document.getElementById('fileMetaGal');

        img.src = url;
        img.onload = () => { URL.revokeObjectURL(url); lastUrlGal = null; };
        meta.textContent = `${file.name} ‚Ä¢ ${humanSize(file.size)} ‚Ä¢ ${file.type || 'imagen'}`;
        wrap.style.display = 'block';
      }
    }

    // Listeners: cada uno muestra su preview debajo del propio bot√≥n
    camInput.addEventListener('change', () => {
      if (camInput.files && camInput.files[0]) {
        galInput.value = '';                 // deseleccionar galer√≠a
        showPreview(camInput.files[0], 'cam');
      }
    });

    galInput.addEventListener('change', () => {
      if (galInput.files && galInput.files[0]) {
        camInput.value = '';                 // deseleccionar c√°mara
        showPreview(galInput.files[0], 'gal');
      }
    });

    /* Enviar formulario */
    tanqueForm.addEventListener('submit', async e=>{
      e.preventDefault();

      // üîΩ Obtener ubicaci√≥n justo antes de enviar
      let latitude = "", longitude = "";
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 8000
          });
        });
        latitude = position.coords.latitude;
        longitude = position.coords.longitude;
      } catch (err) {
        alert("Ubicaci√≥n no disponible: " + err.message);
        return; // opcional: bloquear env√≠o si no hay coordenadas
      }

      const file = camInput.files[0] || galInput.files[0];
      if(!file){ alert("Adjunta una imagen"); return; }

      /* Convertir a Base64 */
      const base64 = await new Promise(res=>{
        const reader = new FileReader();
        reader.onload = ()=>res(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
      });

      const data = {
        tanque      : tanque.value,
        nivel       : document.querySelector('input[name=nivel]:checked')?.value || "",
        supervision : document.querySelector('input[name=supervision]:checked')?.value || "",
        anomalia    : anomalia.value,
        latitud     : latitude,
        longitud    : longitude,
        imgName     : file.name,
        imgData     : base64
      };

      estado.textContent = "Enviando‚Ä¶";

      fetch(WEBAPP_URL, {
        method : "POST",
        mode   : "no-cors",    // evita CORS pre-flight
        body   : JSON.stringify(data)
      })
      .then(()=> estado.textContent = "¬°Enviado correctamente!")
      .catch(err=> estado.textContent = "Error: "+err);
    });
  </script>
</body>
</html>

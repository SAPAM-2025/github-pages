<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revisi√≥n de Tanques Superficiales</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      max-width:600px;
      margin:auto;
      padding:20px;
      background:#f5f7fa;
      color:#333;
    }
    h2{ text-align:center;color:#2c3e50;margin-bottom:25px }
    label{font-weight:bold;margin-top:15px;display:block}
    input[type="text"],
    select,
    button{width:100%;padding:10px;font-size:1em;margin-bottom:15px;
           border:1px solid #ccc;border-radius:5px}
    .hint{margin-top:-10px;margin-bottom:12px;font-size:.85em;color:#607d8b}
    .radio-group{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}
    .radio-group label{display:flex;align-items:center;gap:5px;font-weight:normal}
    button{background:#2c3e50;color:#fff;border:none;cursor:pointer}
    button:hover{background:#1a242f}
    #estado{text-align:center;font-weight:bold;margin-top:20px}

    .picBtn{display:flex;align-items:center;gap:8px;background:#607d8b;
            color:#fff;padding:8px 12px;border-radius:4px;cursor:pointer;
            font-weight:bold;width:max-content}
    .picBtn.cam{background:#2c3e50}
    input[type="file"]{display:none}

    /* Miniaturas compactas al pie de cada bot√≥n */
    .previewWrap{display:none;margin-top:8px}
    .thumbBox{width:180px;height:120px;border:1px dashed #b0bec5;background:#fff;
              display:flex;align-items:center;justify-content:center;border-radius:6px;overflow:hidden}
    .thumb{width:100%;height:100%;object-fit:cover;display:block}
    .fileMeta{font-size:0.85em;color:#546e7a;margin-top:4px;line-height:1.2}
  </style>
</head>
<body>
  <h2>REVISI√ìN DE TANQUES SUPERFICIALES Y ELEVADOS</h2>

  <form id="tanqueForm">
    <!-- Tanque -->
    <label for="tanque">Tanque:</label>
    <select id="tanque" required>
      <option value="">Seleccione‚Ä¶</option>
      <option>GEMELOS</option>
      <option>TANQUE 2</option>
      <option>MEGA TANQUE</option>
      <option>FRANCISCO VILLA</option>
      <option>FONAPO</option>
      <option>LUIS ORTEGA</option>
      <option>BICENTENARIO</option>
    </select>

    <!-- Pocero / Supervisor (lista) -->
    <label for="pocero">Pocero / Supervisor:</label>
    <select id="pocero" required></select>
    <div class="hint">Nombre del <b>Pocero o Supervisor</b> que toma la evidencia <b>Fotogr√°fica</b> y del nivel.</div>

    <!-- Nivel -->
    <label>Nivel del Tanque:</label>
    <div class="radio-group">
      <label><input type="radio" name="nivel" value="1 METRO" required> 1 METRO</label>
      <label><input type="radio" name="nivel" value="2 METROS"> 2 METROS</label>
      <label><input type="radio" name="nivel" value="3 METROS"> 3 METROS</label>
    </div>

    <!-- Supervisi√≥n -->
    <label>Supervisi√≥n del Predio:</label>
    <div class="radio-group">
      <label><input type="radio" name="supervision" value="BIEN" required> BIEN</label>
      <label><input type="radio" name="supervision" value="ANOMALIA"> ANOMALIA</label>
    </div>

    <!-- Anomal√≠a -->
    <label for="anomalia">Narrar Anomal√≠a:</label>
    <input type="text" id="anomalia" placeholder="Describe si aplica" />

    <!-- Evidencia -->
    <label>Evidencia (imagen):</label>

    <!-- Zona de C√ÅMARA con su preview debajo -->
    <div id="camZone" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px">
      <label class="picBtn cam">
        üì∑ Tomar foto
        <input type="file" id="camInput" accept="image/*" capture="environment">
      </label>
      <div id="previewCam" class="previewWrap">
        <div class="thumbBox"><img id="thumbCam" class="thumb" alt="Miniatura c√°mara"></div>
        <div id="fileMetaCam" class="fileMeta"></div>
      </div>
    </div>

    <!-- Zona de GALER√çA con su preview debajo -->
    <div id="galZone" style="display:flex;flex-direction:column;gap:6px;margin-bottom:20px">
      <label class="picBtn">
        üñºÔ∏è Elegir de galer√≠a
        <input type="file" id="galInput" accept="image/*">
      </label>
      <div id="previewGal" class="previewWrap">
        <div class="thumbBox"><img id="thumbGal" class="thumb" alt="Miniatura galer√≠a"></div>
        <div id="fileMetaGal" class="fileMeta"></div>
      </div>
    </div>

    <!-- Coordenadas -->
    <input type="hidden" id="latitud">
    <input type="hidden" id="longitud">

    <button type="submit">Enviar</button>
  </form>

  <p id="estado"></p>

  <script>
    /* URL de tu Web App */
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby86Kg4uFCwiLdVV9etcCGtV0mDGWSsG028zow_yFqhG3BycN0-J4tC_EXx_5HnZyduKw/exec";

    /* ===== Lista de poceros  ===== */
    const POCEROS = [
      { nombre: "FELIPE MARES MORENO",       ini: "FMM" },
      { nombre: "DIEGO ROBERTO VARGAS HERNANDEZ",   ini: "DRVH" },
      { nombre: "SANTIAGO MODESTO DELGADO", ini: "SMD" },
      { nombre: "JAVIER HERNANDEZ RODRIGUEZ", ini: "JHR" },
      { nombre: "CARLOS ALFREDO MARES CASTRO", ini: "CAMC" },
      { nombre: "ROBERTO DAVID GAMEZ PARAMO", ini: "RDGP" },
      { nombre: "JAVIER GONZALES ROSALES", ini: "JGR" },
      { nombre: "JUAN CARLOS DIMAS GARCIA", ini: "JCDG"},
    ];
    function populatePoceros(){
      const sel = document.getElementById('pocero');
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Seleccione‚Ä¶';
      sel.appendChild(opt0);
      POCEROS.forEach(p => {
        const opt = document.createElement('option');
        opt.value = normInitials(p.ini);       // valor = INICIALES normalizadas
        opt.dataset.nombre = p.nombre;         // dataset para enviar nombre al Sheet
        opt.textContent = `${p.nombre} (${normInitials(p.ini)})`;
        sel.appendChild(opt);
      });
    }
    window.addEventListener('DOMContentLoaded', populatePoceros);


    /* M√°s detalle (~800 KB‚Äì1 MB t√≠pico si la foto original es grande) */
    const MAX_W = 2560;
    const MAX_H = 1920;
    const JPEG_QUALITY = 0.90;
    
    let compressedCamBlob = null, compressedGalBlob = null;
    let compressedCamName = null, compressedGalName = null;

    // ===== Normalizadores =====
    const rmDiacritics = (str)=> str.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    function normTankName(str){
      return rmDiacritics(str.trim().toUpperCase())
        .replace(/\s+/g,'-')
        .replace(/[^A-Z0-9\-]/g,'')
        .replace(/\-+/g,'-');
    }
    function normInitials(str){
      return rmDiacritics(String(str || '').trim().toUpperCase()).replace(/[^A-Z]/g,'');
    }
    function two(n){ return n.toString().padStart(2,'0'); }
    function nowStampLocal(){
      const d = new Date();  // hora local del dispositivo
      const Y = d.getFullYear(), M = two(d.getMonth()+1), D = two(d.getDate());
      const h = two(d.getHours()), m = two(d.getMinutes()), s = two(d.getSeconds());
      return `${Y}-${M}-${D}_${h}-${m}-${s}`;
    }
    function randID8(){
      const a = new Uint8Array(4);
      crypto.getRandomValues(a);
      return [...a].map(x=>x.toString(16).padStart(2,'0')).join('');
    }
    function getEstado(){
      return document.querySelector('input[name=supervision]:checked')?.value || 'BIEN';
    }
    function getPocero(){
      const sel = document.getElementById('pocero');
      return {
        ini: normInitials(sel.value || ''),
        nombre: sel.selectedOptions[0]?.dataset?.nombre || ''
      };
    }
    function buildFinalName(){
      const tanqueNorm = normTankName(tanque.value || '');
      const estado = getEstado();
      const { ini } = getPocero();
      const stamp = nowStampLocal();
      const id8 = randID8();
      return `${tanqueNorm}_${stamp}_${estado}_${ini}_${id8}.jpg`;
    }

    // ===== Compresi√≥n =====
    async function compressImage(file){
      const bitmap = (window.createImageBitmap)
        ? await createImageBitmap(file, { imageOrientation: 'from-image' })
        : await new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
          });

      const ow = bitmap.width, oh = bitmap.height;
      const scale = Math.min(MAX_W/ow, MAX_H/oh, 1);
      const w = Math.round(ow * scale), h = Math.round(oh * scale);

      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, w, h);

      const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', JPEG_QUALITY));
      return blob || file;
    }
    function blobToBase64(blob){
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result.split(',')[1]);
        fr.onerror = rej;
        fr.readAsDataURL(blob);
      });
    }
    function humanSize(bytes){
      if (!bytes && bytes !== 0) return "";
      const k=1024,u=["B","KB","MB","GB"];const i=Math.floor(Math.log(bytes)/Math.log(k));
      return (bytes/Math.pow(k,i)).toFixed(1)+" "+u[i];
    }

    // ===== Previews =====
    function setPreview(origin, file, compressedBlob, finalName){
      const isCam = origin==='cam';
      const wrap = document.getElementById(isCam?'previewCam':'previewGal');
      const img  = document.getElementById(isCam?'thumbCam':'thumbGal');
      const meta = document.getElementById(isCam?'fileMetaCam':'fileMetaGal');

      const url = URL.createObjectURL(file);
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);

      const originalTxt = `${file.name} ‚Ä¢ ${humanSize(file.size)}`;
      const compTxt = compressedBlob ? ` ‚ü∂ Env√≠o: ${humanSize(compressedBlob.size)}` : '';
      const nameTxt = finalName ? `<br><b>Nombre final:</b> ${finalName}` : '';
      meta.innerHTML = `${originalTxt}${compTxt}${nameTxt}`;
      wrap.style.display = 'block';
    }

    // ===== Eventos de Inputs =====
    camInput.addEventListener('change', async () => {
      if (camInput.files && camInput.files[0]) {
        galInput.value = '';
        const file = camInput.files[0];

        compressedCamBlob = await compressImage(file);
        const finalName = buildFinalName();
        compressedCamName = finalName;

        document.getElementById('previewGal').style.display = 'none';
        compressedGalBlob = null; compressedGalName = null;
        setPreview('cam', file, compressedCamBlob, finalName);
      }
    });

    galInput.addEventListener('change', async () => {
      if (galInput.files && galInput.files[0]) {
        camInput.value = '';
        const file = galInput.files[0];

        compressedGalBlob = await compressImage(file);
        const finalName = buildFinalName();
        compressedGalName = finalName;

        document.getElementById('previewCam').style.display = 'none';
        compressedCamBlob = null; compressedCamName = null;
        setPreview('gal', file, compressedGalBlob, finalName);
      }
    });

    // ===== Env√≠o =====
    tanqueForm.addEventListener('submit', async e=>{
      e.preventDefault();

      // Validaciones
      if(!tanque.value){ alert("Selecciona un tanque"); return; }
      if(!pocero.value){ alert("Selecciona un pocero/supervisor"); return; }

      // Ubicaci√≥n
      let latitude = "", longitude = "";
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true, timeout: 8000
          });
        });
        latitude = position.coords.latitude;
        longitude = position.coords.longitude;
      } catch (err) {
        alert("Ubicaci√≥n no disponible: " + err.message);
        return;
      }

      // Archivo y nombre final (si cambiaste pocero/estado tras elegir imagen, aqu√≠ se recalcula)
      let blob = null;
      if (camInput.files[0]) {
        blob = compressedCamBlob || await compressImage(camInput.files[0]);
      } else if (galInput.files[0]) {
        blob = compressedGalBlob || await compressImage(galInput.files[0]);
      } else {
        alert("Adjunta una imagen");
        return;
      }
      const finalName = buildFinalName();
      const base64 = await blobToBase64(blob);

      const { ini: poceroIni, nombre: poceroNombre } = getPocero();

      const data = {
        tanque      : tanque.value,
        nivel       : document.querySelector('input[name=nivel]:checked')?.value || "",
        supervision : getEstado(),
        anomalia    : anomalia.value,
        latitud     : latitude,
        longitud    : longitude,
        pocero_ini  : poceroIni,     // << para Sheet
        pocero_nombre: poceroNombre, // << para Sheet
        imgName     : finalName,     // << nombre estandarizado
        imgData     : base64
      };

      estado.textContent = "Enviando‚Ä¶";

      fetch(WEBAPP_URL, {
        method : "POST",
        mode   : "no-cors",
        body   : JSON.stringify(data)
      })
      .then(()=> estado.textContent = "¬°Enviado correctamente!")
      .catch(err=> estado.textContent = "Error: "+err);
    });
  </script>
</body>
</html>



